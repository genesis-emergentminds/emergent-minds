name: Registration Intake

on:
  issues:
    types: [opened]

jobs:
  acknowledge-registration:
    if: contains(github.event.issue.labels.*.name, 'registration')
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Post acknowledgment
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            
            // Extract CID hash from the issue body
            // The structured form puts it in a field, free-form may have it inline
            const cidMatch = body.match(/[`]?([a-f0-9]{64})[`]?/);
            const cidPrefix = cidMatch ? cidMatch[1].substring(0, 16) + '...' : 'unknown';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: [
                `## ‚è≥ Registration Received`,
                ``,
                `Welcome! Your registration has been received.`,
                ``,
                `**CID:** \`${cidPrefix}\``,
                `**Status:** Provisional`,
                ``,
                `**What happens next:**`,
                `1. You are now a **Provisional Member** ‚Äî join our [Matrix community](https://matrix.to/#/#emergent-minds:matrix.org) and start participating`,
                `2. An existing member will connect with you for a brief **Covenant Conversation**`,
                `3. Once vouched, your status will be upgraded to **Active** with full governance rights`,
                ``,
                `During the founding phase, this typically happens within hours.`,
                ``,
                `*‚Äî Genesis Bot üå±*`,
              ].join('\n')
            });
            
            // Add provisional label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['provisional']
            });
